<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>木頭選擇小幫手</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* ===== 色票 & 全域 ===== */
    :root{
      --bg:#f4ede4;          /* 米色底 */
      --card:#ffffff;
      --ink:#2b211d;         /* 字色 */
      --muted:#6f5f56;       /* 次要字 */
      --line:#e6ddd3;        /* 邊框 */
      --brand:#3b2f2f;       /* 深咖主色 */
      --brand-2:#a67c52;     /* 金棕輔色 */
      --chip:#f7f2ec;        /* 輕底 */
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
    .wrap{max-width:640px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:0 10px 30px rgba(59,47,47,.08);padding:18px}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .brand img{width:36px;height:36px;border-radius:10px;object-fit:cover;border:1px solid var(--line)}
    h1{font-size:20px;margin:0}
    p.desc{margin:6px 0 14px;color:var(--muted)}
    label{font-size:12px;color:#5b4a42;margin:6px 0 6px 2px;display:block}
    input[type="text"], input[type="email"], input[type="tel"], textarea{
      width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:14px;outline:none;transition:.2s
    }
    input:focus, textarea:focus{box-shadow:0 0 0 3px rgba(166,124,82,.18);border-color:#d7c7b5}
    .row{margin:10px 0}
    .hint{font-size:12px;color:var(--muted);margin:4px 2px 0}
    .pill{display:inline-block;background:var(--chip);border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px;margin-right:6px;color:#5b4a42}
    .actions{display:flex;gap:10px;margin-top:16px}
    .btn{flex:1;padding:12px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-primary[disabled]{opacity:.6;cursor:not-allowed}
    .btn-secondary{background:#e9e2da;color:#3b2f2f}
    .note{background:#f9f4ee;border:1px solid var(--line);border-radius:12px;padding:10px;font-size:14px;margin:12px 0;color:#3b2f2f}
    .hidden{display:none}
    .spinner{width:18px;height:18px;border:3px solid #e0d6cc;border-top-color:var(--brand);border-radius:50%;animation:spin 1s linear infinite;display:inline-block;vertical-align:-3px}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ===== 單欄分段 ===== */
    .section{padding:10px 0;border-top:1px dashed var(--line)}
    .section:first-of-type{border-top:0}

    /* ===== 圖片選項（色調/紋理） ===== */
    .img-options{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .img-tile{position:relative;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff;cursor:pointer;transition:transform .06s}
    .img-tile:hover{transform:translateY(-1px)}
    .img-tile img{width:100%;height:78px;object-fit:cover;display:block}
    .img-tile span{display:block;text-align:center;padding:8px 6px;font-size:13px}
    .img-tile input{position:absolute;inset:0;opacity:0}
    .img-tile.active{outline:3px solid rgba(166,124,82,.35)}
    .img-tile .check{
      position:absolute;top:8px;right:8px;background:var(--brand);color:#fff;
      font-size:11px;padding:4px 6px;border-radius:999px;display:none
    }
    .img-tile.active .check{display:block}

    /* ===== 卡片化單選（預算/尺寸/濕度/硬度/用途） ===== */
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      border:1px solid var(--line);background:var(--chip);padding:10px 12px;border-radius:999px;font-size:14px;cursor:pointer
    }
    .chip.active{background:var(--brand);color:#fff;border-color:transparent}

    /* ===== 感謝頁（自動關閉） ===== */
    .done{ text-align:center; padding:24px 12px }
    .done .check{
      width:64px;height:64px;border-radius:50%;
      background:var(--brand);color:#fff;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:34px;margin:6px auto 10px;
      box-shadow:0 8px 20px rgba(59,47,47,.25);animation:pop .6s ease both
    }
    @keyframes pop{ 0%{transform:scale(.6);opacity:0} 100%{transform:scale(1);opacity:1} }
    .done h2{ margin:10px 0 6px;font-size:20px }
    .done p{ margin:6px 0 0 }
    .small{ font-size:12px }

    /* ===== 預覽（保留但送出後不顯示） ===== */
    .preview{margin-top:12px;display:grid;grid-template-columns:1fr;gap:10px}
    .item{border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;gap:10px;background:#fff}
    .item img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <!-- Logo + 標題 -->
    <div class="brand">
      <img src="https://shoplineimg.com/5aedc6948d1db923ec006b66/681da57aac0bd3000f11eace/800x.jpg?" alt="logo">
      <div>
        <h1>木頭選擇小幫手</h1>
        <p class="desc">填寫需求後，系統會計算並把 TOP 5 推薦直接送到你的聊天室。</p>
      </div>
    </div>

    <!-- 表單區（送出前可見） -->
    <div id="formArea">
      <div id="status" class="note hidden"></div>

      <!-- 基本資訊 -->
      <div class="section">
        <div class="row">
          <label>Email（選填）</label>
          <input id="email" type="email" placeholder="you@example.com"/>
        </div>
        <div class="row">
          <label>電話（選填）</label>
          <input id="phone" type="tel" placeholder="例：0912-345-678"/>
        </div>
        <div class="row">
          <label>居住地（城市/區域）</label>
          <input id="location" type="text" placeholder="例：台北市內湖區"/>
        </div>
      </div>

      <!-- 預算區間（預設不選） -->
      <div class="section">
        <label>預算（NT$）</label>
        <div id="budgetGroup" class="chips">
          <span class="chip" data-min="5000"  data-max="10000">5,000–10,000</span>
          <span class="chip" data-min="10000" data-max="20000">10,000–20,000</span>
          <span class="chip" data-min="20000" data-max="30000">20,000–30,000</span>
          <span class="chip" data-min="30000" data-max="50000">30,000–50,000</span>
          <span class="chip" data-min="50000" data-max="999999">50,000 以上</span>
        </div>
      </div>

      <!-- 硬度偏好（比擬說明；預設不選） -->
      <div class="section">
        <label>硬度偏好</label>
        <div id="hardnessGroup" class="chips">
          <span class="chip" data-val="1">柔軟（指甲易留痕）</span>
          <span class="chip" data-val="2">偏軟（銅幣可刮痕）</span>
          <span class="chip" data-val="3">適中（指甲略可留痕）</span>
          <span class="chip" data-val="4">偏硬（小刀才刮得動）</span>
          <span class="chip" data-val="5">很硬（日常工具難留痕）</span>
        </div>
        <div class="hint">參考物：指甲≈2.5、銅幣≈3、小刀/玻璃≈5.5、鑽石=10（直覺比擬）</div>
      </div>

      <!-- 常態濕度（預設不選） -->
      <div class="section">
        <label>居家常態濕度</label>
        <div id="humidityGroup" class="chips">
          <span class="chip" data-min="30" data-max="40">乾燥（冬季北方 30–40%）</span>
          <span class="chip" data-min="55" data-max="65">一般室內（冷氣除濕 55–65%）</span>
          <span class="chip" data-min="70" data-max="85">潮濕（沿海/梅雨 70–85%）</span>
        </div>
      </div>

      <!-- 用途（預設不選） -->
      <div class="section">
        <label>用途</label>
        <div id="usageGroup" class="chips">
          <span class="chip" data-val="dining">餐桌</span>
          <span class="chip" data-val="desk">書桌</span>
          <span class="chip" data-val="meeting">會議桌</span>
          <span class="chip" data-val="workbench">工作台</span>
        </div>
      </div>

      <!-- 色調（圖片；預設不選） -->
      <div class="section">
        <label>色調</label>
        <div id="toneGroup" class="img-options">
          <label class="img-tile" data-val="any">
            <input type="radio" name="tone">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTkstOR0_rUkWPyiJAvqNnmCxprxWqgbX4X05dqtg-tSAe-x5WPfWx4OjEK4cmMnSXL7ps&usqp=CAU" alt="不拘">
            <span>不拘</span><div class="check">已選</div>
          </label>
          <label class="img-tile" data-val="light">
            <input type="radio" name="tone">
            <img src="https://shoplineimg.com/5aedc6948d1db923ec006b66/6756c488298b07000a27802f/720x.jpeg?" alt="淺色">
            <span>淺色</span><div class="check">已選</div>
          </label>
          <label class="img-tile" data-val="medium">
            <input type="radio" name="tone">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSePnW-NcXAUP2s0rtPMXCJ7X27ty-ROqaigw&s" alt="中性">
            <span>中性</span><div class="check">已選</div>
          </label>
          <label class="img-tile" data-val="dark">
            <input type="radio" name="tone">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSpxHG4ouOhhEBqvClzgJIjmTN6NygXsjVIWw&s" alt="深色">
            <span>深色</span><div class="check">已選</div>
          </label>
        </div>
        <div class="hint">圖片僅示意，實際以木種與表面處理為準。</div>
      </div>

      <!-- 紋理（圖片；預設不選） -->
      <div class="section">
        <label>紋理</label>
        <div id="grainGroup" class="img-options">
          <label class="img-tile" data-val="any">
            <input type="radio" name="grain">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR7e6Yy8cPzxaKm8uai-QJ3FNVhyw6LpKyGXg&s" alt="不拘">
            <span>不拘</span><div class="check">已選</div>
          </label>
          <label class="img-tile" data-val="straight">
            <input type="radio" name="grain">
            <img src="https://shoplineimg.com/5aedc6948d1db923ec006b66/6756c488298b07000a27802f/720x.jpeg?" alt="直紋">
            <span>直紋</span><div class="check">已選</div>
          </label>
          <label class="img-tile" data-val="curly">
            <input type="radio" name="grain">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRsG9VTLT-RWNFGnK5T_k06nsdIK7NecvSjkQ&s" alt="渦紋/虎斑">
            <span>渦紋/虎斑</span><div class="check">已選</div>
          </label>
          <label class="img-tile" data-val="knotty">
            <input type="radio" name="grain">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQflfH6KdyGOXGc86-8hnLXngOzAp1jFmhD4Q&s" alt="節疤感">
            <span>節疤感</span><div class="check">已選</div>
          </label>
        </div>
      </div>

      <!-- 尺寸（固定選項 + 自訂；預設不選） -->
      <div class="section">
        <label>期望桌面尺寸（cm）</label>
        <div id="sizeGroup" class="chips">
          <span class="chip" data-val="180x90">180×90</span>
          <span class="chip" data-val="160x80">160×80</span>
          <span class="chip" data-val="200x90">200×90</span>
          <span class="chip" data-val="240x100">240×100</span>
          <span class="chip" data-val="custom">自訂</span>
        </div>
        <div id="sizeCustomRow" class="row hidden">
          <input id="sizeCustom" type="text" placeholder="請輸入尺寸，例如 210×95"/>
        </div>
      </div>

      <!-- 其他需求 -->
      <div class="section">
        <label>其他需求（選填）</label>
        <textarea id="notes" rows="3" placeholder="例：偏愛直紋、需抗刮、2 週內交貨…"></textarea>
      </div>

      <div class="actions">
        <button class="btn btn-secondary" id="reset">清除</button>
        <button class="btn btn-primary" id="submit">送出</button>
      </div>

      <!-- （可選）結果預覽：保留，但送出成功後改顯示感謝頁 -->
      <div class="preview hidden" id="preview"></div>
    </div>

    <!-- 完成畫面（5 秒後自動關閉） -->
    <div id="doneArea" class="done hidden">
      <div class="check">✓</div>
      <h2>系統檢測中</h2>
      <p>我們正在為你運算最合適的 TOP 5，並將透過官方 LINE 傳送。</p>
      <p class="small" style="color:var(--muted)">本視窗將在 <b><span id="countdown">5</span> 秒</b> 後自動關閉。</p>
    </div>

  </div>
</div>

<script>
  // ===== 已替換：LIFF 與 n8n Webhook =====
  const LIFF_ID = "2008055834-dzj3yJYv";
  const N8N_WEBHOOK = "https://xin03.zeabur.app/webhook/umu";

  const $ = (id)=>document.getElementById(id);
  const statusEl = $("status");
  const previewEl = $("preview");

  // 公用：chip/圖片選擇的 active 切換
  function bindChipGroup(containerId, onChange){
    const el = document.getElementById(containerId);
    el.addEventListener('click', (e)=>{
      const chip = e.target.closest('.chip'); if(!chip) return;
      el.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
      onChange && onChange(chip);
    });
    return el;
  }
  function bindImgOptions(groupId){
    const g = document.getElementById(groupId);
    g.addEventListener('click', (e)=>{
      const tile = e.target.closest('.img-tile'); if(!tile) return;
      g.querySelectorAll('.img-tile').forEach(t=>t.classList.remove('active'));
      tile.classList.add('active');
    });
  }

  // 狀態訊息
  function setStatus(msg, loading=false){
    statusEl.classList.remove("hidden");
    statusEl.innerHTML = loading ? `<span class="spinner"></span> ${msg}` : msg;
  }
  function clearStatus(){ statusEl.classList.add('hidden'); statusEl.innerHTML=''; }

  // 切換到完成頁並 5 秒後自動關閉
  function showDone(){
    clearStatus();
    document.getElementById('formArea').classList.add('hidden');
    document.getElementById('doneArea').classList.remove('hidden');
    window.scrollTo({top:0,behavior:'smooth'});

    let sec = 5;
    const c = document.getElementById('countdown');
    const timer = setInterval(()=>{
      sec--; if(c) c.textContent = String(sec);
      if(sec<=0){
        clearInterval(timer);
        if (typeof liff !== 'undefined' && liff.closeWindow) {
          liff.closeWindow();
        } else {
          window.close();
        }
      }
    }, 1000);
  }

  // 初始化 LIFF
  async function initLIFF(){
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()) liff.login();
    const prof = await liff.getProfile();
    window._lineUserId = prof.userId;
  }

  // 綁定群組（預設不選）
  bindChipGroup('budgetGroup');
  bindChipGroup('hardnessGroup');
  bindChipGroup('humidityGroup');
  bindChipGroup('usageGroup');
  bindImgOptions('toneGroup');
  bindImgOptions('grainGroup');

  // 尺寸「自訂」顯示
  bindChipGroup('sizeGroup', (chip)=>{
    $("sizeCustomRow").classList.toggle('hidden', chip.dataset.val !== 'custom');
  });

  // 取得群組選擇（未選回 null）
  const getActive = (sel)=>document.querySelector(`${sel} .active`);

  // 清除（恢復全未選）
  $("reset").onclick = ()=>{
    document.querySelectorAll("input[type='text'],input[type='email'],input[type='tel'],textarea").forEach(el=>el.value="");
    document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    document.querySelectorAll('.img-options').forEach(g=>{
      g.querySelectorAll('.img-tile').forEach(t=>t.classList.remove('active'));
    });
    $("sizeCustomRow").classList.add('hidden');
    clearStatus(); previewEl.classList.add('hidden'); previewEl.innerHTML='';
  };

  // 送出（必填檢查 & 送出）
  $("submit").onclick = async ()=>{
    try{
      const btn = $("submit");
      btn.disabled = true;

      // 必填檢查：每個群組都需選擇
      const need = [
        { id:'#budgetGroup',   name:'預算' },
        { id:'#hardnessGroup', name:'硬度偏好' },
        { id:'#humidityGroup', name:'居家常態濕度' },
        { id:'#usageGroup',    name:'用途' },
        { id:'#toneGroup',     name:'色調',   img:true },
        { id:'#grainGroup',    name:'紋理',   img:true },
        { id:'#sizeGroup',     name:'期望桌面尺寸' }
      ];
      for(const n of need){
        const act = n.img ? document.querySelector(`${n.id} .img-tile.active`) : getActive(n.id);
        if(!act){
          btn.disabled = false;
          setStatus(`請先選擇「${n.name}」`, false);
          document.querySelector(n.id).scrollIntoView({behavior:'smooth', block:'center'});
          return;
        }
      }

      // 取值
      const budgetChip = getActive('#budgetGroup');
      const budget = { min:Number(budgetChip.dataset.min), max:Number(budgetChip.dataset.max), label: budgetChip.textContent.trim() };

      const hardness = Number(getActive('#hardnessGroup').dataset.val);

      const humidityChip = getActive('#humidityGroup');
      const humidity = { min:Number(humidityChip.dataset.min), max:Number(humidityChip.dataset.max) };

      const usage = getActive('#usageGroup').dataset.val;

      const tone  = document.querySelector('#toneGroup .img-tile.active').dataset.val;
      const grain = document.querySelector('#grainGroup .img-tile.active').dataset.val;

      const sizeChip = getActive('#sizeGroup').dataset.val;
      const size = sizeChip==='custom' ? $("sizeCustom").value.trim() : sizeChip;
      if(sizeChip==='custom' && !size){
        btn.disabled=false;
        setStatus('請輸入自訂尺寸（例如 210×95）');
        $("sizeCustom").focus();
        return;
      }

      const payload = {
        lineUserId: window._lineUserId,
        email: $("email").value.trim() || null,
        phone: $("phone").value.trim() || null,
        location: $("location").value.trim() || null,
        budget, hardness, humidity, usage, tone, grain, size,
        notes: $("notes").value.trim() || null,
        ts: Date.now()
      };

      setStatus("系統檢測中，結果將透過官方 LINE 傳送給你…", true);

      const res = await fetch(N8N_WEBHOOK, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        showDone();   // 成功 → 切換為完成頁並自動關閉
      } else {
        setStatus("送出失敗，請稍後再試或改用人工客服。");
        btn.disabled = false;
      }
    }catch(e){
      console.error(e);
      setStatus("送出失敗，請稍後再試或改用人工客服。");
      $("submit").disabled = false;
    }
  };

  // 啟動
  initLIFF();
</script>
</body>
</html>
